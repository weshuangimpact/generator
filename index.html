<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統部署生成器 | OHACSS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* =========================================
           1. 全域變數與基礎設定
           ========================================= */
        :root {
            --brand-dark: #202124;
            --brand-bg: #f8f9fa; 
            --card-border: #e0e0e0;
            --main-font: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }

        body {
            font-family: var(--main-font);
            background-color: var(--brand-bg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }

        /* =========================================
           2. Header (Navbar) 樣式
           ========================================= */
        .navbar {
            background-color: var(--brand-dark) !important;
            min-height: 85px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        /* =========================================
           3. Footer 樣式
           ========================================= */
        footer {
            background-color: var(--brand-dark) !important;
            color: #fff;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: auto; 
            padding: 15px 0;
            min-height: 85px;
            z-index: 10;
        }

        /* =========================================
           4. 主內容區 (Generator UI)
           ========================================= */
        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .generator-container {
            text-align: center;
            max-width: 1000px;
            width: 100%;
        }

        h1 {
            color: var(--brand-dark);
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        p.subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        /* 卡片按鈕區 (改為3欄) */
        .action-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
        }

        @media (max-width: 992px) {
            .action-cards { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            .action-cards { grid-template-columns: 1fr; }
        }

        .card-btn {
            background: #fff;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: inherit;
        }

        .card-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            border-color: var(--brand-dark);
        }

        .card-btn i {
            font-size: 3.5rem;
            color: var(--brand-dark);
            margin-bottom: 10px;
        }

        .card-btn h3 {
            margin: 0;
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--brand-dark);
        }

        .card-btn span {
            font-size: 0.95rem;
            color: #666;
        }

        /* =========================================
           5. Modal 樣式微調 (搭配 Bootstrap)
           ========================================= */
        .modal-header {
            border-bottom: 2px solid var(--brand-dark);
            background-color: #fff;
        }
        
        .modal-title {
            color: var(--brand-dark);
            font-weight: 700;
        }

        .form-label {
            font-weight: 600;
            color: var(--brand-dark);
        }

        .form-text {
            font-size: 0.85em;
            color: #888;
        }

        .btn-brand {
            background-color: var(--brand-dark);
            color: white;
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-brand:hover {
            background-color: #3a3b3e;
            color: white;
        }

        .status-msg {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }
        .status-success { color: #198754; }
        .status-error { color: #dc3545; }

    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center p-0">
            <a class="navbar-brand d-flex align-items-center fw-bold" href="#">
                <i class="fas fa-shield-alt me-2"></i> OHACSS 系統部署生成器
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3 small" id="header-date"><i class="fas fa-spinner fa-spin"></i></span>
                <span class="text-white small border-start ps-3 border-secondary" id="header-clock" style="opacity: 0.9;">--:--</span>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="generator-container">
            <h1>系統部署檔案生成中心</h1>
            <p class="subtitle">請選擇您要執行的重建任務類型</p>

            <div class="action-cards">
                <div class="card-btn" data-bs-toggle="modal" data-bs-target="#modal-db">
                    <i class="fa-solid fa-database"></i>
                    <div>
                        <h3>資料庫重建 (SQL)</h3>
                        <span>Tables, RLS, Storage Buckets</span>
                    </div>
                </div>

                <div class="card-btn" data-bs-toggle="modal" data-bs-target="#modal-edge">
                    <i class="fa-solid fa-bolt"></i>
                    <div>
                        <h3>Edge Functions (ZIP)</h3>
                        <span>6 支核心功能打包</span>
                    </div>
                </div>

                <div class="card-btn" data-bs-toggle="modal" data-bs-target="#modal-config">
                    <i class="fa-solid fa-code"></i>
                    <div>
                        <h3>前端設定檔 (JS)</h3>
                        <span>資料庫連線 config.js</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="mb-1">可信智慧整合有限公司 42917004</div>
        <div class="small opacity-75" style="font-family: 'Segoe UI', sans-serif; letter-spacing: 1px;">
            WesmartAI , Making Trust Transparent.
        </div>
    </footer>

    <div class="modal fade" id="modal-db" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">資料庫 SQL 生成設定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <div class="mb-3">
                        <label class="form-label">Supabase 專案網址 (Project URL)</label>
                        <input type="text" class="form-control" id="db-project-url" placeholder="例: https://okvbtpyeenwmkmzkrxkk.supabase.co">
                        <div class="form-text">用於設定 Webhook 觸發器 (自動補全 functions 路徑)</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Service Role Key (Secret)</label>
                        <input type="password" class="form-control" id="db-service-key" placeholder="eyJ...">
                        <div class="form-text">用於觸發器權限驗證 (請至 Project Settings > API 取得)</div>
                    </div>
                    <div id="status-db" class="status-msg"></div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-brand w-100" onclick="generateSQL()">生成並下載 SQL</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-edge" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edge Functions 打包設定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <div class="mb-3">
                        <label class="form-label">系統寄件者信箱 (Sender Email)</label>
                        <input type="email" class="form-control" id="ef-sender" placeholder="noreply@wesmartai.net" value="noreply@wesmartai.net">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">前端登入網址 (Login URL)</label>
                        <input type="text" class="form-control" id="ef-login" value="https://wesmartai.net/OHACSS_Test/index.html">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">重設密碼網址 (Reset Password URL)</label>
                        <input type="text" class="form-control" id="ef-reset" value="https://wesmartai.net/OHACSS_Test/reset_password.html">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">評鑑改善網址 (Act URL)</label>
                        <input type="text" class="form-control" id="ef-act" value="https://wesmartai.net/OHACSS_Test/index5.html">
                    </div>
                    <div id="status-ef" class="status-msg"></div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-brand w-100" onclick="generateEdgeZip()">生成並下載 ZIP</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-config" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">前端設定檔 (config.js) 生成</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <div class="alert alert-info py-2 small" role="alert">
                        <i class="fas fa-info-circle me-1"></i>
                        提示：系統頁面路徑皆採<strong>相對路徑</strong>，因此只需更新新資料庫的連線參數，無須填寫新網域位置。
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supabase 專案網址 (URL)</label>
                        <input type="text" class="form-control" id="cfg-url" placeholder="例: https://okvbtpyeenwmkmzkrxkk.supabase.co">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supabase 公開金鑰 (Anon Key)</label>
                        <input type="password" class="form-control" id="cfg-anon-key" placeholder="sb_publishable_...">
                        <div class="form-text">此為前端用金鑰，請至 Project Settings > API 取得 (anon / public)</div>
                    </div>
                    <div id="status-cfg" class="status-msg"></div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-brand w-100" onclick="generateConfig()">生成並下載 JS</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==========================================
        // 0. 頁面初始化 (時鐘功能)
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            setInterval(() => {
                const el = document.getElementById('header-clock');
                if(el) el.textContent = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            }, 1000);
            
            const dateEl = document.getElementById('header-date');
            if(dateEl) {
                const now = new Date();
                const days = ['日', '一', '二', '三', '四', '五', '六'];
                const formattedDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
                dateEl.innerHTML = `<i class="far fa-calendar-alt me-1"></i>今日是 ${formattedDate}`;
            }
        });

        // ==========================================
        // 1. 資料庫 SQL 生成邏輯 (包含 RLS 修正)
        // ==========================================
        const SQL_TEMPLATE = `
-- ==============================================================================
-- 第一部分：建立資料庫基礎結構 (Functions, Tables, Triggers, RLS)
-- ==============================================================================

-- 0. 建立共用稽核觸發函數
CREATE OR REPLACE FUNCTION public.handle_audit_log()
RETURNS TRIGGER AS $$
BEGIN
  IF (TG_OP = 'DELETE') THEN
    INSERT INTO public.audit_logs (action_type, target_table, user_id, details)
    VALUES (TG_OP, TG_TABLE_NAME, auth.uid(), row_to_json(OLD)::text);
    RETURN OLD;
  ELSE
    INSERT INTO public.audit_logs (action_type, target_table, user_id, details)
    VALUES (TG_OP, TG_TABLE_NAME, auth.uid(), row_to_json(NEW)::text);
    RETURN NEW;
  END IF;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 0.1 建立判斷管理員函數 (避免 RLS 無窮迴圈)
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS boolean AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'admin'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 1-8 建立資料表 (Audit, Staff, Profiles, Companies, Workplaces, Records, Staging, Evidence)
create table public.audit_logs (
  id uuid not null default gen_random_uuid (),
  user_role text null, user_name text null, action_type text null, target_table text null, details text null, ip_address text null,
  created_at timestamp with time zone null default timezone ('utc'::text, now()), user_id uuid null,
  constraint audit_logs_pkey primary key (id),
  constraint audit_logs_user_id_fkey foreign KEY (user_id) references auth.users (id) on delete set null
) TABLESPACE pg_default;
create index IF not exists idx_audit_logs_user_id on public.audit_logs using btree (user_id) TABLESPACE pg_default;

create table public.medical_staff (
  id uuid not null default gen_random_uuid (),
  name text not null, role text not null, employment_type text null, phone text null, email text null, user_id uuid null,
  system_role text null default 'medical'::text, onboard_year integer null default 2020, is_active boolean null default true,
  created_at timestamp with time zone null default timezone ('utc'::text, now()), onboard_date date null, resignation_date date null, created_by uuid null, updated_by uuid null,
  constraint medical_staff_pkey primary key (id),
  constraint medical_staff_created_by_fkey foreign KEY (created_by) references auth.users (id),
  constraint medical_staff_updated_by_fkey foreign KEY (updated_by) references auth.users (id)
) TABLESPACE pg_default;
create index IF not exists idx_medical_staff_created_by on public.medical_staff using btree (created_by) TABLESPACE pg_default;
create trigger on_medical_staff_audit after INSERT or DELETE or update on medical_staff for EACH row execute FUNCTION handle_audit_log ();

create table public.profiles (
  id uuid not null default gen_random_uuid (),
  email text null, full_name text null, role text null, status text null default 'active'::text,
  created_at timestamp with time zone null default now(), last_sign_in_at timestamp with time zone null, created_by uuid null, updated_by uuid null, is_active boolean null default true,
  constraint profiles_pkey primary key (id),
  constraint profiles_created_by_fkey foreign KEY (created_by) references auth.users (id),
  constraint profiles_updated_by_fkey foreign KEY (updated_by) references auth.users (id)
) TABLESPACE pg_default;
create index IF not exists idx_profiles_updated_by on public.profiles using btree (updated_by) TABLESPACE pg_default;
create trigger on_profiles_audit after INSERT or DELETE or update on profiles for EACH row execute FUNCTION handle_audit_log ();

create table public.companies (
  id uuid not null default gen_random_uuid (),
  tax_id text not null, name text not null, address text null, contact_person text null, phone text null,
  created_at timestamp with time zone null default timezone ('utc'::text, now()), service_year integer null default 2025,
  contract_start_date date null, contract_end_date date null, is_active boolean null default true, created_by uuid null, updated_by uuid null, consultant_id uuid null,
  constraint companies_pkey primary key (id), constraint companies_tax_id_key unique (tax_id),
  constraint companies_consultant_id_fkey foreign KEY (consultant_id) references medical_staff (id) on delete set null,
  constraint companies_created_by_fkey foreign KEY (created_by) references auth.users (id),
  constraint companies_updated_by_fkey foreign KEY (updated_by) references auth.users (id)
) TABLESPACE pg_default;
create index IF not exists idx_companies_consultant_id on public.companies using btree (consultant_id) TABLESPACE pg_default;
create trigger on_companies_audit after INSERT or DELETE or update on companies for EACH row execute FUNCTION handle_audit_log ();

create table public.workplaces (
  id uuid not null default gen_random_uuid (),
  company_id uuid not null, department_name text null default '全廠'::text, hazard_type text null, hazard_count integer null default 0,
  created_at timestamp with time zone null default timezone ('utc'::text, now()), created_by uuid null, updated_by uuid null,
  admin_male integer null default 0, admin_female integer null default 0, site_male integer null default 0, site_female integer null default 0,
  constraint workplaces_pkey primary key (id),
  constraint workplaces_company_id_fkey foreign KEY (company_id) references companies (id) on delete CASCADE,
  constraint workplaces_created_by_fkey foreign KEY (created_by) references auth.users (id),
  constraint workplaces_updated_by_fkey foreign KEY (updated_by) references auth.users (id)
) TABLESPACE pg_default;
create trigger on_workplaces_audit after INSERT or DELETE or update on workplaces for EACH row execute FUNCTION handle_audit_log ();

create table public.service_records (
  id uuid not null default gen_random_uuid (),
  workplace_id uuid not null, visit_date date null, start_time time without time zone null, end_time time without time zone null, service_year integer null,
  process_desc text null, hazard_desc text null, raw_data jsonb null, created_at timestamp with time zone null default timezone ('utc'::text, now()), consultant_id uuid null,
  work_pattern text null, execution_items text null, issues_found text null, measures_taken text null, tracking_status text null, attachment_files jsonb null default '[]'::jsonb,
  created_by uuid null, updated_by uuid null, storage_verified boolean null default false, last_verification_at timestamp with time zone null, is_special_case boolean null default false,
  audit_note text null, parent_record_id uuid null, attachment_folder_id uuid null, additional_appendices jsonb null default '[]'::jsonb, case_number text null, management_plans jsonb null default '{}'::jsonb,
  constraint service_records_pkey primary key (id), constraint service_records_case_number_key unique (case_number),
  constraint service_records_workplace_id_fkey foreign KEY (workplace_id) references workplaces (id),
  constraint service_records_consultant_id_fkey foreign KEY (consultant_id) references medical_staff (id)
) TABLESPACE pg_default;
create index IF not exists idx_service_records_consultant on public.service_records using btree (consultant_id) TABLESPACE pg_default;

-- ⚠️ 自動驗證檔案觸發器
create trigger "auto-verify-files"
after INSERT or update on service_records for EACH row
execute FUNCTION supabase_functions.http_request (
  '<<URL_PLACEHOLDER>>',
  'POST',
  '{"Content-type":"application/json","Authorization":"Bearer <<TOKEN_PLACEHOLDER>>","Content-Type":"application/json"}',
  '{}',
  '5000'
);
create trigger on_service_records_audit after INSERT or DELETE or update on service_records for EACH row execute FUNCTION handle_audit_log ();

create table public.service_record_staging (
  id uuid not null default gen_random_uuid (),
  workplace_id uuid not null, submitter_id uuid null, service_date date not null, service_type text null, service_desc text null,
  attachment_files jsonb null default '[]'::jsonb, status text null default 'pending'::text, reviewer_comment text null,
  created_at timestamp with time zone null default timezone ('utc'::text, now()), updated_at timestamp with time zone null default timezone ('utc'::text, now()),
  visit_date date null, start_time time without time zone null, end_time time without time zone null, consultant_id uuid null, reviewer_id uuid null, updated_by uuid null, created_by uuid null,
  is_special_case boolean null default false, audit_note text null, origin_record_id uuid null, service_year integer null, case_number text null, improvement_records jsonb null default '[]'::jsonb,
  constraint service_record_staging_pkey primary key (id), constraint service_record_staging_case_number_key unique (case_number),
  constraint service_record_staging_origin_record_id_fkey foreign KEY (origin_record_id) references service_records (id),
  constraint service_record_staging_workplace_id_fkey foreign KEY (workplace_id) references workplaces (id)
) TABLESPACE pg_default;

create table public.evidence (
  id uuid not null default gen_random_uuid (),
  created_at timestamp with time zone null default now(), updated_at timestamp with time zone null default now(), updated_by text null,
  workplace_id uuid null, consultant_id uuid null, visit_date date null, service_year integer null, start_time time without time zone null, end_time time without time zone null,
  execution_items text null, file_url text null, status text null default 'pending'::text, attachment_folder_id uuid null, is_special_case boolean null default false,
  audit_note text null, additional_appendices jsonb not null default '[]'::jsonb, review_date date null, assessment_records jsonb null default '[]'::jsonb, assessment_updated_by text null,
  evaluation_reviews jsonb null default '[]'::jsonb, improvement_records jsonb null default '[]'::jsonb, evaluation_status text null default 'pending'::text, case_number text null,
  reviewer_id uuid null, service_type text null, process_desc text null, issues_found text null, measures_taken text null, work_pattern text null, hazard_desc text null, tracking_status text null,
  origin_staging_id uuid null, assessment_logs jsonb null default '[]'::jsonb, act_improvements jsonb null default '[]'::jsonb,
  constraint evidence_pkey primary key (id), constraint evidence_case_number_key unique (case_number),
  constraint evidence_consultant_id_fkey foreign KEY (consultant_id) references medical_staff (id),
  constraint evidence_origin_staging_id_fkey foreign KEY (origin_staging_id) references service_record_staging (id),
  constraint evidence_workplace_id_fkey foreign KEY (workplace_id) references workplaces (id) on delete CASCADE
) TABLESPACE pg_default;

-- 9. 建立 RLS Policies
ALTER TABLE public.audit_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.companies ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.evidence ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.medical_staff ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.service_record_staging ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.service_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.workplaces ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable insert for all" ON public.audit_logs FOR INSERT TO public WITH CHECK (true);
CREATE POLICY "Enable select for all" ON public.audit_logs FOR SELECT TO public USING (true);
CREATE POLICY "Allow All" ON public.companies FOR ALL TO public USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for evidence" ON public.evidence FOR ALL TO public USING (true) WITH CHECK (true);
CREATE POLICY "Allow All" ON public.medical_staff FOR ALL TO public USING (true) WITH CHECK (true);

-- ✅ 修正後的 Profiles 政策 (使用 is_admin 避免迴圈)
CREATE POLICY "Admins can insert profiles" ON public.profiles FOR INSERT TO authenticated WITH CHECK ( public.is_admin() );
CREATE POLICY "Admins can select profiles" ON public.profiles FOR SELECT TO authenticated USING ( public.is_admin() );
CREATE POLICY "Admins can update profiles" ON public.profiles FOR UPDATE TO authenticated USING ( public.is_admin() );
CREATE POLICY "Enable insert for admins and self" ON public.profiles FOR INSERT TO authenticated WITH CHECK ( auth.uid() = id OR public.is_admin() );
CREATE POLICY "Enable read access for all authenticated users" ON public.profiles FOR SELECT TO authenticated USING ( true );
CREATE POLICY "Enable update for admins" ON public.profiles FOR UPDATE TO authenticated USING ( public.is_admin() );
CREATE POLICY "Enable update for own profile" ON public.profiles FOR UPDATE TO authenticated USING ( auth.uid() = id ) WITH CHECK ( auth.uid() = id );

CREATE POLICY "Allow authenticated insert" ON public.service_record_staging FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY "Allow authenticated select" ON public.service_record_staging FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow authenticated update" ON public.service_record_staging FOR UPDATE TO authenticated USING (true);
CREATE POLICY "Allow All" ON public.service_records FOR ALL TO public USING (true) WITH CHECK (true);
CREATE POLICY "Allow All" ON public.workplaces FOR ALL TO public USING (true) WITH CHECK (true);

-- ==============================================================================
-- 第二部分：建立 Storage Buckets 與 Policies
-- ==============================================================================
INSERT INTO storage.buckets (id, name, public)
VALUES 
  ('plans', 'plans', true),
  ('evidence', 'evidence', true),
  ('staging', 'staging', true) -- ⚠️ Staging 設定為 Public
ON CONFLICT (id) DO UPDATE SET public = EXCLUDED.public;

CREATE POLICY "Allow public select plans" ON storage.objects FOR SELECT TO public USING (bucket_id = 'plans');
CREATE POLICY "Allow authenticated insert plans" ON storage.objects FOR INSERT TO authenticated WITH CHECK (bucket_id = 'plans');
CREATE POLICY "Allow authenticated update plans" ON storage.objects FOR UPDATE TO authenticated USING (bucket_id = 'plans');
CREATE POLICY "Allow authenticated delete plans" ON storage.objects FOR DELETE TO authenticated USING (bucket_id = 'plans');

CREATE POLICY "Allow Public Select evidence" ON storage.objects FOR SELECT TO public USING (bucket_id = 'evidence');
CREATE POLICY "Allow Public Insert evidence" ON storage.objects FOR INSERT TO public WITH CHECK (bucket_id = 'evidence');
CREATE POLICY "Allow Public Update evidence" ON storage.objects FOR UPDATE TO public USING (bucket_id = 'evidence');

CREATE POLICY "Allow authenticated select staging" ON storage.objects FOR SELECT TO authenticated USING (bucket_id = 'staging');
CREATE POLICY "Allow authenticated insert staging" ON storage.objects FOR INSERT TO authenticated WITH CHECK (bucket_id = 'staging');
CREATE POLICY "Allow authenticated update staging" ON storage.objects FOR UPDATE TO authenticated USING (bucket_id = 'staging');
CREATE POLICY "Allow authenticated delete staging" ON storage.objects FOR DELETE TO authenticated USING (bucket_id = 'staging');
`;

        function generateSQL() {
            const projectUrlInput = document.getElementById('db-project-url').value.trim();
            const serviceKey = document.getElementById('db-service-key').value.trim();
            const statusDiv = document.getElementById('status-db');

            if (!projectUrlInput || !serviceKey) {
                statusDiv.innerText = "❌ 請完整填寫網址與 Key";
                statusDiv.className = "status-msg status-error";
                return;
            }

            let cleanUrl = projectUrlInput.replace(/\/functions\/v1\/verify-storage\/?$/, '');
            if (cleanUrl.endsWith('/')) cleanUrl = cleanUrl.slice(0, -1);
            const fullUrl = `${cleanUrl}/functions/v1/verify-storage`;

            let finalSQL = SQL_TEMPLATE.replace('<<URL_PLACEHOLDER>>', fullUrl)
                                       .replace('<<TOKEN_PLACEHOLDER>>', serviceKey);

            const blob = new Blob([finalSQL], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "DB_Reconstruction.sql";
            link.click();

            statusDiv.innerText = "✅ SQL 檔已下載，請至 Supabase SQL Editor 執行";
            statusDiv.className = "status-msg status-success";
        }

        // ==========================================
        // 2. Edge Functions 打包邏輯 (完整無刪減版)
        // ==========================================
        async function generateEdgeZip() {
            const sender = document.getElementById('ef-sender').value.trim();
            const login = document.getElementById('ef-login').value.trim();
            const reset = document.getElementById('ef-reset').value.trim();
            const act = document.getElementById('ef-act').value.trim();
            const statusDiv = document.getElementById('status-ef');

            if (!sender || !login || !reset || !act) {
                statusDiv.innerText = "❌ 請完整填寫所有欄位";
                statusDiv.className = "status-msg status-error";
                return;
            }

            statusDiv.innerText = "⏳ 正在打包 ZIP...";
            statusDiv.className = "status-msg";

            const zip = new JSZip();

            // ✅ 以下皆為 100% 原始碼完整保留，並妥善處理字串跳脫，以動態注入網址與信箱
            const files = {
                "reset-password": `import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const RESEND_API_KEY = Deno.env.get("RESEND_API_KEY");
const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");

if (!RESEND_API_KEY || !SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {
  throw new Error("Missing required environment variables");
}

interface ResetRequest {
  email: string;
  redirectTo?: string;
}

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  if (req.method !== "POST") {
    return new Response(JSON.stringify({ error: "Method not allowed" }), {
      status: 405,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }

  try {
    const { email } = (await req.json()) as ResetRequest; // 這裡不拿 redirectTo 了，反正也不用

    if (!email) {
      throw new Error("Email is required");
    }

    // ✅ 強制指定正確網址，無視前端傳來的參數 (替換為生成器輸入網址)
    const finalRedirectUrl = "${reset}";

    const supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

    const { data: linkData, error: linkError } = await supabaseAdmin.auth.admin.generateLink({
      type: "recovery",
      email,
      options: {
        // ✅ 這裡只放變數，不接受前端參數
        redirectTo: finalRedirectUrl,
      },
    });

    if (linkError) throw linkError;

    const actionUrl = linkData.properties.action_link;
    const { subject, html } = getEmailContent(email, actionUrl);

    const res = await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: \`Bearer \${RESEND_API_KEY}\`,
      },
      body: JSON.stringify({
        from: "OHACSS 職業健康評鑑與合規支援系統通知 <${sender}>",
        to: email,
        subject,
        html,
      }),
    });

    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(\`Resend API Error: \${errorText}\`);
    }

    const data = await res.json();

    return new Response(JSON.stringify(data), {
      status: 200,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  } catch (error: any) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 400,
      headers: { ...corsHeaders, "Content-Type": "application/json" },
    });
  }
});

function getEmailContent(email: string, actionUrl: string) {
  const subject = "【OHACSS】職業健康評鑑與合規支援系統重設密碼通知";
  const html = \`
<!DOCTYPE html>
<html>
<head><meta charset="utf-8"></head>
<body style="font-family:'Segoe UI','Microsoft JhengHei',sans-serif;background-color:#f8f9fa;margin:0;padding:20px;">
  <div style="background:#ffffff;max-width:600px;margin:0 auto;padding:20px;border:1px solid #e0e0e0;border-radius:8px;">
    <h2 style="color:#0dcaf0;border-bottom:2px solid #0dcaf0;padding-bottom:10px;">
      重設您的密碼
    </h2>
    <p>我們收到了您重設 <strong>\${email}</strong> 帳號密碼的請求。</p>
    <div style="background:#f8f9fa;padding:20px;border-radius:6px;margin:20px 0;">
      請點擊下方按鈕進行重設（連結有效時間為 24 小時）：
    </div>
    <div style="text-align:center;margin:30px 0;">
      <a href="\${actionUrl}"
         style="background:#0dcaf0;color:white;padding:12px 24px;text-decoration:none;border-radius:6px;font-weight:bold;">
        重設我的密碼
      </a>
    </div>
    <p style="font-size:12px;color:#999;text-align:center;">
      若您未提出此請求，請忽略本信件。
    </p>
  </div>
</body>
</html>\`;
  return { subject, html };
}`,

                "send-email": `import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

/* =====================================================
 * 1. 設定 API Key (從 Supabase Secrets 環境變數讀取)
 * ===================================================== */
const RESEND_API_KEY = Deno.env.get("RESEND_API_KEY");

/* =====================================================
 * 2. 型別定義
 * ===================================================== */
interface MailRequest {
  type: "activate";
  email: string;
  data: any;
}

/* =====================================================
 * 3. CORS 設定
 * ===================================================== */
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type",
};

/* =====================================================
 * 4. Server 主程式
 * ===================================================== */
serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    const { type, email, data } = (await req.json()) as MailRequest;

    // 取得對應模板內容
    const { subject, html } = getEmailContent(type, data);

    // 呼叫 Resend API
    const res = await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: \`Bearer \${RESEND_API_KEY}\`,
      },
      body: JSON.stringify({
        from: "OHACSS 管理中心 <${sender}>",
        to: email,
        subject,
        html,
      }),
    });

    const result = await res.json();

    if (!res.ok) {
      throw new Error(JSON.stringify(result));
    }

    return new Response(JSON.stringify(result), {
      headers: {
        ...corsHeaders,
        "Content-Type": "application/json",
      },
    });
  } catch (error: any) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 400,
      headers: {
        ...corsHeaders,
        "Content-Type": "application/json",
      },
    });
  }
});

/* =====================================================
 * 5. 郵件模板工廠 (Template Factory)
 * ===================================================== */
function getEmailContent(type: string, data: any) {
  const LOGIN_URL = "${login}";

  switch (type) {
    case "activate":
      return {
        subject: "【OHACSS】帳號開通通知",
        html: \`
        <div style="font-family:'Microsoft JhengHei',sans-serif;max-width:600px;margin:0 auto;padding:20px;border:1px solid #e0e0e0;border-radius:8px;">
          <h2 style="color:#0dcaf0;border-bottom:2px solid #0dcaf0;padding-bottom:10px;">
            歡迎加入 OHCASS 職業健康評鑑與合規支援系統
          </h2>
          <p style="font-size:16px;color:#333;">
            Hi <strong>\${data.name}</strong>,
          </p>
          <p style="color:#555;">您的管理員已為您開通系統權限。</p>
          <div style="background:#f8f9fa;padding:20px;border-radius:6px;margin:20px 0;border-left:5px solid #0dcaf0;">
            <p><strong>登入帳號：</strong>\${data.email}</p>
            <p>
              <strong>預設密碼：</strong>
              <span style="font-family:monospace;background:#e9ecef;padding:2px 6px;border-radius:4px;font-weight:bold;color:#d63384;">
                12345678
              </span>
            </p>
          </div>
          <div style="text-align:center;margin:30px 0;">
            <a href="\${LOGIN_URL}"
               style="background:#0dcaf0;color:white;padding:12px 24px;
                      text-decoration:none;border-radius:4px;font-weight:bold;">
              立即登入系統
            </a>
          </div>
          <p style="color:#333;">
            請於登入後 <strong>立即更改密碼</strong> 以確保帳號安全。
          </p>
          <p style="font-size:12px;color:#999;text-align:center;">
            此為系統自動發送信件，請勿直接回覆。
          </p>
        </div>
        \`,
      };

    default:
      throw new Error(\`不支援的郵件類型: \${type}\`);
  }
}`,

                "send-evaluation-revision": `import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const RESEND_API_KEY = Deno.env.get("RESEND_API_KEY");
const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    const { id } = await req.json();
    if (!id) {
      return new Response(JSON.stringify({ error: "Missing id" }), {
        status: 400,
        headers: corsHeaders,
      });
    }

    // 查 evidence (修正：增加讀取 case_number)
    const dbRes = await fetch(
      \`\${SUPABASE_URL}/rest/v1/evidence?id=eq.\${id}&select=case_number,evaluation_reviews,medical_staff(name,email),workplaces(companies(name))\`,
      {
        headers: {
          apikey: SERVICE_ROLE_KEY!,
          Authorization: \`Bearer \${SERVICE_ROLE_KEY}\`,
        },
      }
    );

    const [data] = await dbRes.json();
    if (!data) throw new Error("Evidence not found");

    const to = data.medical_staff.email;
    const companyName = data.workplaces.companies.name;
    const consultantName = data.medical_staff.name;
    const caseNumber = data.case_number || "無案號";
    const reviews = data.evaluation_reviews || [];

    // 格式化評鑑審查紀錄 (理由)
    const reviewHtml =
      reviews.length > 0
        ? \`<ul style="background:#fff0f0; padding:15px 20px; border-left:4px solid #c0392b; color:#555;">\${reviews
            .map((r: any) => \`<li><strong style="color:#333;">\${r.date || "未記錄日期"}</strong>：\${r.note}</li>\`)
            .join("")}</ul>\`
        : "<p>目前尚無評鑑審查紀錄。</p>";

    const html = \`
      <div style="font-family:'Microsoft JhengHei',sans-serif;max-width:600px;margin:0 auto;color:#333;">
        <h2 style="color:#202124; border-bottom:2px solid #ffc107; padding-bottom:10px;">評鑑補件通知</h2>
        <p>親愛的 <strong>\${consultantName}</strong> 顧問：</p>
        <p>您負責的「<strong>\${companyName}</strong>」案件經評鑑審查後，需要進行補正。</p>
        
        <div style="background:#f8f9fa; padding:15px; border-radius:6px; margin:20px 0;">
            <p style="margin:0; font-size:14px; color:#666;">請使用以下案號進行作業：</p>
            <h3 style="margin:5px 0; color:#0d6efd; letter-spacing:1px;">\${caseNumber}</h3>
        </div>

        <p><strong>審查意見與需補正事項：</strong></p>
        \${reviewHtml}
        
        <hr style="border:0; border-top:1px dashed #ddd; margin:20px 0;">

        <p style="font-weight:bold;">請依下列步驟完成補件：</p>
        <ol style="line-height:1.6;">
            <li>複製上方案號：<span style="background:#eee; padding:2px 6px;">\${caseNumber}</span></li>
            <li>點擊下方連結進入 <strong>評鑑改善專區 (Act)</strong></li>
            <li>輸入案號調閱案件，並上傳改善說明與佐證附件</li>
        </ol>

        <div style="text-align:center; margin:30px 0;">
            <a href="${act}" 
               style="background-color:#dc3545; color:white; padding:12px 25px; text-decoration:none; border-radius:5px; font-weight:bold; display:inline-block;">
               前往評鑑改善專區
            </a>
        </div>

        <p style="font-size:12px;color:#999; margin-top:40px; border-top:1px solid #eee; padding-top:10px;">
            此為系統自動發送通知，請勿直接回覆。<br>
            OHACSS 職業健康評鑑與合規支援系統 | WesmartAI
        </p>
      </div>
    \`;

    const mailRes = await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: \`Bearer \${RESEND_API_KEY}\`,
      },
      body: JSON.stringify({
        /* ✅ 嚴格保留設定：使用已驗證的正式網域 (由生成器替換) */
        from: "OHCASS <${sender}>",
        to,
        subject: \`【OHCASS】職業健康評鑑與合規支援系統評鑑補件通知 (\${caseNumber})：\${companyName}\`,
        html,
      }),
    });

    const result = await mailRes.json();

    return new Response(JSON.stringify(result), {
      status: mailRes.ok ? 200 : 400,
      headers: corsHeaders,
    });
  } catch (err: any) {
    return new Response(
      JSON.stringify({ error: err.message }),
      { status: 500, headers: corsHeaders }
    );
  }
});`,

                "send-reminder": `import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const RESEND_API_KEY = Deno.env.get("RESEND_API_KEY");

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    const { email, consultantName, companyName } = await req.json();

    const res = await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: \`Bearer \${RESEND_API_KEY}\`,
      },
      body: JSON.stringify({
        /* ✅ 唯一修正點：改用已驗證網域 */
        from: "OHSMS 系統通知 <${sender}>",
        to: email,
        subject: \`【OHCASS】職業健康評鑑與合規支援系統催收通知：尚未結案提醒 (\${companyName})\`,
        html: \`
        <div style="font-family:'Microsoft JhengHei',sans-serif;max-width:600px;margin:0 auto;padding:20px;border:1px solid #e0e0e0;border-radius:8px;">
          <h2 style="color:#ffc107;border-bottom:2px solid #ffc107;padding-bottom:10px;">
            案件催收通知
          </h2>
          <p style="font-size:16px;color:#333;">親愛的 <strong>\${consultantName}</strong> 顧問：</p>
          <p style="color:#555;">
            關於您負責的「<strong>\${companyName}</strong>」服務紀錄，
            目前仍為 <span style="color:#dc3545;font-weight:bold;">待審查 (暫存)</span> 狀態。
          </p>

          <div style="background:#f8f9fa;padding:15px;border-radius:6px;margin:20px 0;">
            請盡速登入 OHACSS 職業健康評鑑與合規支援系統確認並補齊所需文件，以利系統結案程序，確保資料合規。
          </div>

          <a href="${login}"
             style="display:inline-block;background:#198754;color:white;padding:10px 20px;text-decoration:none;border-radius:4px;margin-top:10px;">
            立即登入處理
          </a>
        </div>
        \`,
      }),
    });

    if (!res.ok) {
      throw new Error(JSON.stringify(await res.json()));
    }

    return new Response(
      JSON.stringify({ success: true }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (error: any) {
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 400, headers: corsHeaders }
    );
  }
});`,

                "send-review": `import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const RESEND_API_KEY = Deno.env.get("RESEND_API_KEY");

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers":
    "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    const body = await req.json();

    const email = body.email;
    const consultantName = body.consultantName;
    const companyName = body.companyName;
    const reason = body.reason;
    const deadline = body.deadline;

    // ✅ 案號多來源相容（避免前端未同步）
    const caseNo =
      body.caseNo ||
      body.case_no ||
      body.caseId ||
      body.case_id ||
      body.recordNo ||
      body.record_no;

    if (!email || !caseNo) {
      return new Response(
        JSON.stringify({
          error: "缺少必要參數",
          receivedKeys: Object.keys(body),
        }),
        {
          status: 400,
          headers: { ...corsHeaders, "Content-Type": "application/json" },
        }
      );
    }

    const res = await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: \`Bearer \${RESEND_API_KEY}\`,
      },
      body: JSON.stringify({
        /* ✅ 唯一修正點：改用你已驗證的正式寄信網域 */
        from: "OHACSS 職業健康評鑑與合規支援系統通知 <${sender}>",
        to: email,
        subject: \`【OHCASS】職業健康評鑑與合規支援系統案件補正通知｜案號 \${caseNo}\`,
        html: \`
        <div style="font-family:'Microsoft JhengHei',sans-serif;max-width:600px;margin:0 auto;padding:20px;border:1px solid #e0e0e0;border-radius:8px;">
          <h2 style="color:#dc3545;border-bottom:2px solid #dc3545;padding-bottom:10px;">
            案件審查通知（需補件）
          </h2>

          <p style="font-size:15px;color:#555;">
            案件案號：<strong>\${caseNo}</strong>
          </p>

          <p style="font-size:16px;color:#333;">
            親愛的 <strong>\${consultantName}</strong> 顧問：
          </p>

          <p style="color:#555;">
            您為「<strong>\${companyName}</strong>」所提交之服務案件，經系統審查後需進行補正。
          </p>

          <div style="background:#e7f1ff;padding:15px;border-left:4px solid #0d6efd;margin:20px 0;">
            <strong style="color:#0d6efd;font-size:16px;">💡 快速補件指南：</strong><br>
            <span style="color:#333;">請登入 OHCASS職業健康評鑑與合規支援系統 系統，在「搜尋條件」輸入以下案件編號，即可快速找回此案進行補件：</span>
            <div style="margin-top:10px;padding:10px;background:#fff;border:1px dashed #0d6efd;text-align:center;font-size:20px;font-weight:bold;color:#dc3545;letter-spacing:1px;">
              \${caseNo}
            </div>
          </div>

          <div style="background:#fff3cd;padding:15px;border-left:4px solid #ffc107;margin:20px 0;">
            <strong>【需補正原因 / 建議】</strong><br>
            <span style="color:#664d03;white-space:pre-wrap;">\${reason}</span>
          </div>

          <p style="color:#dc3545;font-weight:bold;">
            ※ 請於 \${deadline} 日內登入 OHACSS 職業健康評鑑與合規支援系統完成補正。
          </p>

          <a href="${login}"
             style="display:inline-block;background:#202124;color:white;padding:10px 20px;text-decoration:none;border-radius:4px;margin-top:10px;">
            登入系統處理
          </a>
        </div>
        \`,
      }),
    });

    if (!res.ok) {
      throw new Error(JSON.stringify(await res.json()));
    }

    return new Response(
      JSON.stringify({ success: true, caseNo }),
      {
        headers: { ...corsHeaders, "Content-Type": "application/json" },
      }
    );
  } catch (err: any) {
    return new Response(
      JSON.stringify({ error: err.message }),
      { status: 400, headers: corsHeaders }
    );
  }
});`,

                "verify-storage": `// ====================================================================
// Edge Function: verify-storage
// 用途：檢查 Service Record 的附件是否真的存在於 Storage，且包含主紀錄表
// ====================================================================

import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

// 設定 CORS headers (允許前端直接呼叫，如果需要的話)
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

Deno.serve(async (req) => {
  // 1. 處理 CORS Preflight Request
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    // 2. 初始化 Supabase Client (使用 Service Role Key 以獲得最高權限)
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    )

    // 3. 解析請求 (預期收到 record_id)
    const { record_id } = await req.json()

    if (!record_id) {
      throw new Error('缺少 record_id 參數')
    }

    // 4. 從資料庫撈取該筆紀錄的附件資訊
    const { data: record, error: dbError } = await supabase
      .from('service_records')
      .select('attachment_files, workplace_id')
      .eq('id', record_id)
      .single()

    if (dbError || !record) {
      throw new Error(\`找不到紀錄: \${dbError?.message}\`)
    }

    // 5. 解析附件 JSON
    let files = []
    if (record.attachment_files) {
      files = typeof record.attachment_files === 'string' 
        ? JSON.parse(record.attachment_files) 
        : record.attachment_files
    }

    // 若無附件，直接判定為不合格
    if (!Array.isArray(files) || files.length === 0) {
      await updateStatus(supabase, record_id, false)
      return new Response(JSON.stringify({ verified: false, reason: '無附件' }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      })
    }

    // 6. 開始驗證邏輯
    let allFilesExist = true
    let hasMainRecord = false
    const bucketName = 'documents' // 依據您的 PDF 設定

    for (const file of files) {
      const fileName = (file.name || '').toLowerCase()
      const filePath = file.path // 必須確認您的 JSON 裡有 path 欄位

      // (A) 檢查是否為主紀錄表 (關鍵字檢查)
      if (fileName.includes('紀錄表') || fileName.includes('訪視') || fileName.includes('checklist')) {
        hasMainRecord = true
      }

      // (B) 檢查 Storage 實體檔案是否存在
      if (filePath) {
        // 為了效能，我們只檢查 Metadata 不下載檔案
        // 這裡需要解析路徑，通常 path 是 "folder/filename.pdf"
        // 我們使用 Storage 的 list 方法來確認檔案是否在該路徑下
        
        // 簡易驗證法：嘗試取得 Signed URL (如果檔案不存在通常不會報錯，但無法下載)
        // 嚴格驗證法：List Bucket
        
        // 這裡我們假設 file.path 是完整的儲存路徑 (e.g., "company_A/2024/report.pdf")
        const folder = filePath.substring(0, filePath.lastIndexOf('/'))
        const targetFile = filePath.substring(filePath.lastIndexOf('/') + 1)
        
        const { data: listData, error: storageError } = await supabase
          .storage
          .from(bucketName)
          .list(folder, {
            search: targetFile // 搜尋該檔名
          })

        // 如果搜尋結果是空的，或者找不到完全符合的檔名
        const found = listData && listData.some(f => f.name === targetFile)
        
        if (!found) {
            console.log(\`Missing file: \${filePath}\`)
            allFilesExist = false
            break // 只要缺一個就失敗
        }
      } else {
          // 如果 JSON 裡沒有 path 資訊，無法驗證
          allFilesExist = false
      }
    }

    // 7. 最終判定：必須所有檔案都在 Storage + 包含主紀錄表
    const isVerified = allFilesExist && hasMainRecord

    // 8. 寫回資料庫
    await updateStatus(supabase, record_id, isVerified)

    return new Response(
      JSON.stringify({ 
        verified: isVerified, 
        details: { hasMainRecord, allFilesExist, fileCount: files.length } 
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )

  } catch (err: any) {
    return new Response(
      JSON.stringify({ error: err.message }),
      { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    )
  }
})

// 輔助函式：更新資料庫狀態
async function updateStatus(supabase: any, id: string, status: boolean) {
  await supabase.from('service_records').update({ 
    storage_verified: status,
    last_verification_at: new Date().toISOString()
  }).eq('id', id)
}`
            };

            for (const [name, content] of Object.entries(files)) {
                zip.file(`supabase/functions/${name}/index.ts`, content);
            }

            const blob = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "supabase_functions.zip";
            link.click();

            statusDiv.innerText = "✅ ZIP 檔已下載，請解壓並執行 CLI 部署";
            statusDiv.className = "status-msg status-success";
        }

        // ==========================================
        // 3. Config.js 產生邏輯
        // ==========================================
        function generateConfig() {
            const url = document.getElementById('cfg-url').value.trim();
            const anonKey = document.getElementById('cfg-anon-key').value.trim();
            const statusDiv = document.getElementById('status-cfg');

            if (!url || !anonKey) {
                statusDiv.innerText = "❌ 請完整填寫網址與 Anon Key";
                statusDiv.className = "status-msg status-error";
                return;
            }

            // 清理網址斜線
            const cleanUrl = url.endsWith('/') ? url.slice(0, -1) : url;

            const configContent = `// config.js
// 目的：集中管理 全站共用設定 (資料庫、品牌資訊、頁面路徑)

const AppConfig = {
    // 1. 資料庫連線設定 (Supabase)
    Supabase: {
        URL: '${cleanUrl}',
        KEY: '${anonKey}', 
        BUCKET_NAME: 'staging'
    },

    // 2. 系統品牌資訊
    System: {
        APP_NAME: 'OHACSS 職業健康評鑑與合規支援系統',
        COMPANY_NAME: '可信智慧整合有限公司',
        TAX_ID: '42917004',
        SLOGAN: 'WesmartAI , Making Trust Transparent.'
    },

    // 3. 核心頁面路徑對照 (相對路徑即可)
    Paths: {
        LOGIN: 'index.html',
        DASHBOARD: 'dashboard.html',
        RESET_PASSWORD: 'reset_password.html',
        INDEX: 'index.html'
    },

    // 4. Storage Keys
    StorageKeys: {
        USER_ID: 'currentUserId',
        USER_ROLE: 'currentUserRole',
        USER_NAME: 'currentUserName'
    }
};

window.AppConfig = AppConfig;
`;

            const blob = new Blob([configContent], { type: 'text/javascript' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "config.js";
            link.click();

            statusDiv.innerText = "✅ config.js 檔已下載，請覆蓋前端對應檔案";
            statusDiv.className = "status-msg status-success";
        }
    </script>
</body>
</html>
