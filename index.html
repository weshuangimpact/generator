<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統部署生成器 | OHACSS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        /* =========================================
           1. 全域變數與基礎設定
           ========================================= */
        :root {
            --brand-dark: #202124;
            --brand-bg: #f8f9fa; 
            --card-border: #e0e0e0;
            --main-font: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
        }

        body {
            font-family: var(--main-font);
            background-color: var(--brand-bg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }

        /* =========================================
           2. Header (Navbar) 樣式
           ========================================= */
        .navbar {
            background-color: var(--brand-dark) !important;
            min-height: 85px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        /* =========================================
           3. Footer 樣式
           ========================================= */
        footer {
            background-color: var(--brand-dark) !important;
            color: #fff;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: auto; 
            padding: 15px 0;
            min-height: 85px;
            z-index: 10;
        }

        /* =========================================
           4. 主內容區 (Generator UI)
           ========================================= */
        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .generator-container {
            text-align: center;
            max-width: 1000px;
            width: 100%;
        }

        h1 {
            color: var(--brand-dark);
            font-weight: 700;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        p.subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        /* 卡片按鈕區 (改為3欄) */
        .action-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
        }

        @media (max-width: 992px) {
            .action-cards { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            .action-cards { grid-template-columns: 1fr; }
        }

        .card-btn {
            background: #fff;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 40px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: inherit;
        }

        .card-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            border-color: var(--brand-dark);
        }

        .card-btn i {
            font-size: 3.5rem;
            color: var(--brand-dark);
            margin-bottom: 10px;
        }

        .card-btn h3 {
            margin: 0;
            font-weight: 700;
            font-size: 1.3rem;
            color: var(--brand-dark);
        }

        .card-btn span {
            font-size: 0.95rem;
            color: #666;
        }

        /* =========================================
           5. Modal 樣式微調 (搭配 Bootstrap)
           ========================================= */
        .modal-header {
            border-bottom: 2px solid var(--brand-dark);
            background-color: #fff;
        }
        
        .modal-title {
            color: var(--brand-dark);
            font-weight: 700;
        }

        .form-label {
            font-weight: 600;
            color: var(--brand-dark);
        }

        .form-text {
            font-size: 0.85em;
            color: #888;
        }

        .btn-brand {
            background-color: var(--brand-dark);
            color: white;
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-brand:hover {
            background-color: #3a3b3e;
            color: white;
        }

        .status-msg {
            margin-top: 15px;
            font-weight: bold;
            text-align: center;
        }
        .status-success { color: #198754; }
        .status-error { color: #dc3545; }

    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark px-4">
        <div class="container-fluid d-flex justify-content-between align-items-center p-0">
            <a class="navbar-brand d-flex align-items-center fw-bold" href="#">
                <i class="fas fa-shield-alt me-2"></i> OHACSS 系統部署生成器
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3 small" id="header-date"><i class="fas fa-spinner fa-spin"></i></span>
                <span class="text-white small border-start ps-3 border-secondary" id="header-clock" style="opacity: 0.9;">--:--</span>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="generator-container">
            <h1>系統部署檔案生成中心</h1>
            <p class="subtitle">請選擇您要執行的重建任務類型</p>

            <div class="action-cards">
                <div class="card-btn" data-bs-toggle="modal" data-bs-target="#modal-db">
                    <i class="fa-solid fa-database"></i>
                    <div>
                        <h3>資料庫重建 (SQL)</h3>
                        <span>Tables, RLS, Storage Buckets</span>
                    </div>
                </div>

                <div class="card-btn" data-bs-toggle="modal" data-bs-target="#modal-edge">
                    <i class="fa-solid fa-bolt"></i>
                    <div>
                        <h3>Edge Functions (ZIP)</h3>
                        <span>6 支核心功能打包</span>
                    </div>
                </div>

                <div class="card-btn" data-bs-toggle="modal" data-bs-target="#modal-config">
                    <i class="fa-solid fa-code"></i>
                    <div>
                        <h3>前端設定檔 (JS)</h3>
                        <span>資料庫連線 config.js</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="mb-1">可信智慧整合有限公司 42917004</div>
        <div class="small opacity-75" style="font-family: 'Segoe UI', sans-serif; letter-spacing: 1px;">
            WesmartAI , Making Trust Transparent.
        </div>
    </footer>

    <div class="modal fade" id="modal-db" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">資料庫 SQL 生成設定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <div class="mb-3">
                        <label class="form-label">Supabase 專案網址 (Project URL)</label>
                        <input type="text" class="form-control" id="db-project-url" placeholder="例: https://okvbtpyeenwmkmzkrxkk.supabase.co">
                        <div class="form-text">用於設定 Webhook 觸發器 (自動補全 functions 路徑)</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Service Role Key (Secret)</label>
                        <input type="password" class="form-control" id="db-service-key" placeholder="eyJ...">
                        <div class="form-text">用於觸發器權限驗證 (請至 Project Settings > API 取得)</div>
                    </div>
                    <div id="status-db" class="status-msg"></div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-brand w-100" onclick="generateSQL()">生成並下載 SQL</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-edge" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edge Functions 打包設定</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <div class="mb-3">
                        <label class="form-label">系統寄件者信箱 (Sender Email)</label>
                        <input type="email" class="form-control" id="ef-sender" placeholder="noreply@wesmartai.net" value="noreply@wesmartai.net">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">前端登入網址 (Login URL)</label>
                        <input type="text" class="form-control" id="ef-login" value="https://wesmartai.net/OHACSS_Test/index.html">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">重設密碼網址 (Reset Password URL)</label>
                        <input type="text" class="form-control" id="ef-reset" value="https://wesmartai.net/OHACSS_Test/reset_password.html">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">評鑑改善網址 (Act URL)</label>
                        <input type="text" class="form-control" id="ef-act" value="https://wesmartai.net/OHACSS_Test/index5.html">
                    </div>
                    <div id="status-ef" class="status-msg"></div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-brand w-100" onclick="generateEdgeZip()">生成並下載 ZIP</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-config" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">前端設定檔 (config.js) 生成</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <div class="alert alert-info py-2 small" role="alert">
                        <i class="fas fa-info-circle me-1"></i>
                        提示：系統頁面路徑皆採<strong>相對路徑</strong>，因此只需更新新資料庫的連線參數，無須填寫新網域位置。
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supabase 專案網址 (URL)</label>
                        <input type="text" class="form-control" id="cfg-url" placeholder="例: https://okvbtpyeenwmkmzkrxkk.supabase.co">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supabase 公開金鑰 (Anon Key)</label>
                        <input type="password" class="form-control" id="cfg-anon-key" placeholder="sb_publishable_...">
                        <div class="form-text">此為前端用金鑰，請至 Project Settings > API 取得 (anon / public)</div>
                    </div>
                    <div id="status-cfg" class="status-msg"></div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-brand w-100" onclick="generateConfig()">生成並下載 JS</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==========================================
        // 0. 頁面初始化 (時鐘功能)
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            setInterval(() => {
                const el = document.getElementById('header-clock');
                if(el) el.textContent = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            }, 1000);
            
            const dateEl = document.getElementById('header-date');
            if(dateEl) {
                const now = new Date();
                const days = ['日', '一', '二', '三', '四', '五', '六'];
                const formattedDate = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}(${days[now.getDay()]})`;
                dateEl.innerHTML = `<i class="far fa-calendar-alt me-1"></i>今日是 ${formattedDate}`;
            }
        });

        // ==========================================
        // 1. 資料庫 SQL 生成邏輯
        // ==========================================
        const SQL_TEMPLATE = `
-- ==============================================================================
-- 第一部分：建立資料庫基礎結構 (Functions, Tables, Triggers, RLS)
-- ==============================================================================

-- 0. 建立共用稽核觸發函數
CREATE OR REPLACE FUNCTION public.handle_audit_log()
RETURNS TRIGGER AS $$
BEGIN
  IF (TG_OP = 'DELETE') THEN
    INSERT INTO public.audit_logs (action_type, target_table, user_id, details)
    VALUES (TG_OP, TG_TABLE_NAME, auth.uid(), row_to_json(OLD)::text);
    RETURN OLD;
  ELSE
    INSERT INTO public.audit_logs (action_type, target_table, user_id, details)
    VALUES (TG_OP, TG_TABLE_NAME, auth.uid(), row_to_json(NEW)::text);
    RETURN NEW;
  END IF;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 1-8 建立資料表 (Audit, Staff, Profiles, Companies, Workplaces, Records, Staging, Evidence)
create table public.audit_logs (
  id uuid not null default gen_random_uuid (),
  user_role text null, user_name text null, action_type text null, target_table text null, details text null, ip_address text null,
  created_at timestamp with time zone null default timezone ('utc'::text, now()), user_id uuid null,
  constraint audit_logs_pkey primary key (id),
  constraint audit_logs_user_id_fkey foreign KEY (user_id) references auth.users (id) on delete set null
) TABLESPACE pg_default;
create index IF not exists idx_audit_logs_user_id on public.audit_logs using btree (user_id) TABLESPACE pg_default;

create table public.medical_staff (
  id uuid not null default gen_random_uuid (),
  name text not null, role text not null, employment_type text null, phone text null, email text null, user_id uuid null,
  system_role text null default 'medical'::text, onboard_year integer null default 2020, is_active boolean null default true,
  created_at timestamp with time zone null default timezone ('utc'::text, now()), onboard_date date null, resignation_date date null, created_by uuid null, updated_by uuid null,
  constraint medical_staff_pkey primary key (id),
  constraint medical_staff_created_by_fkey foreign KEY (created_by) references auth.users (id),
  constraint medical_staff_updated_by_fkey foreign KEY (updated_by) references auth.users (id)
) TABLESPACE pg_default;
create index IF not exists idx_medical_staff_created_by on public.medical_staff using btree (created_by) TABLESPACE pg_default;
create trigger on_medical_staff_audit after INSERT or DELETE or update on medical_staff for EACH row execute FUNCTION handle_audit_log ();

create table public.profiles (
  id uuid not null default gen_random_uuid (),
  email text null, full_name text null, role text null, status text null default 'active'::text,
  created_at timestamp with time zone null default now(), last_sign_in_at timestamp with time zone null, created_by uuid null, updated_by uuid null, is_active boolean null default true,
  constraint profiles_pkey primary key (id),
  constraint profiles_created_by_fkey foreign KEY (created_by) references auth.users (id),
  constraint profiles_updated_by_fkey foreign KEY (updated_by) references auth.users (id)
) TABLESPACE pg_default;
create index IF not exists idx_profiles_updated_by on public.profiles using btree (updated_by) TABLESPACE pg_default;
create trigger on_profiles_audit after INSERT or DELETE or update on profiles for EACH row execute FUNCTION handle_audit_log ();

create table public.companies (
  id uuid not null default gen_random_uuid (),
  tax_id text not null, name text not null, address text null, contact_person text null, phone text null,
  created_at timestamp with time zone null default timezone ('utc'::text, now()), service_year integer null default 2025,
  contract_start_date date null, contract_end_date date null, is_active boolean null default true, created_by uuid null, updated_by uuid null, consultant_id uuid null,
  constraint companies_pkey primary key (id), constraint companies_tax_id_key unique (tax_id),
  constraint companies_consultant_id_fkey foreign KEY (consultant_id) references medical_staff (id) on delete set null,
  constraint companies_created_by_fkey foreign KEY (created_by) references auth.users (id),
  constraint companies_updated_by_fkey foreign KEY (updated_by) references auth.users (id)
) TABLESPACE pg_default;
create index IF not exists idx_companies_consultant_id on public.companies using btree (consultant_id) TABLESPACE pg_default;
create trigger on_companies_audit after INSERT or DELETE or update on companies for EACH row execute FUNCTION handle_audit_log ();

create table public.workplaces (
  id uuid not null default gen_random_uuid (),
  company_id uuid not null, department_name text null default '全廠'::text, hazard_type text null, hazard_count integer null default 0,
  created_at timestamp with time zone null default timezone ('utc'::text, now()), created_by uuid null, updated_by uuid null,
  admin_male integer null default 0, admin_female integer null default 0, site_male integer null default 0, site_female integer null default 0,
  constraint workplaces_pkey primary key (id),
  constraint workplaces_company_id_fkey foreign KEY (company_id) references companies (id) on delete CASCADE,
  constraint workplaces_created_by_fkey foreign KEY (created_by) references auth.users (id),
  constraint workplaces_updated_by_fkey foreign KEY (updated_by) references auth.users (id)
) TABLESPACE pg_default;
create trigger on_workplaces_audit after INSERT or DELETE or update on workplaces for EACH row execute FUNCTION handle_audit_log ();

create table public.service_records (
  id uuid not null default gen_random_uuid (),
  workplace_id uuid not null, visit_date date null, start_time time without time zone null, end_time time without time zone null, service_year integer null,
  process_desc text null, hazard_desc text null, raw_data jsonb null, created_at timestamp with time zone null default timezone ('utc'::text, now()), consultant_id uuid null,
  work_pattern text null, execution_items text null, issues_found text null, measures_taken text null, tracking_status text null, attachment_files jsonb null default '[]'::jsonb,
  created_by uuid null, updated_by uuid null, storage_verified boolean null default false, last_verification_at timestamp with time zone null, is_special_case boolean null default false,
  audit_note text null, parent_record_id uuid null, attachment_folder_id uuid null, additional_appendices jsonb null default '[]'::jsonb, case_number text null, management_plans jsonb null default '{}'::jsonb,
  constraint service_records_pkey primary key (id), constraint service_records_case_number_key unique (case_number),
  constraint service_records_workplace_id_fkey foreign KEY (workplace_id) references workplaces (id),
  constraint service_records_consultant_id_fkey foreign KEY (consultant_id) references medical_staff (id)
) TABLESPACE pg_default;
create index IF not exists idx_service_records_consultant on public.service_records using btree (consultant_id) TABLESPACE pg_default;

-- ⚠️ 自動驗證檔案觸發器
create trigger "auto-verify-files"
after INSERT or update on service_records for EACH row
execute FUNCTION supabase_functions.http_request (
  '<<URL_PLACEHOLDER>>',
  'POST',
  '{"Content-type":"application/json","Authorization":"Bearer <<TOKEN_PLACEHOLDER>>","Content-Type":"application/json"}',
  '{}',
  '5000'
);
create trigger on_service_records_audit after INSERT or DELETE or update on service_records for EACH row execute FUNCTION handle_audit_log ();

create table public.service_record_staging (
  id uuid not null default gen_random_uuid (),
  workplace_id uuid not null, submitter_id uuid null, service_date date not null, service_type text null, service_desc text null,
  attachment_files jsonb null default '[]'::jsonb, status text null default 'pending'::text, reviewer_comment text null,
  created_at timestamp with time zone null default timezone ('utc'::text, now()), updated_at timestamp with time zone null default timezone ('utc'::text, now()),
  visit_date date null, start_time time without time zone null, end_time time without time zone null, consultant_id uuid null, reviewer_id uuid null, updated_by uuid null, created_by uuid null,
  is_special_case boolean null default false, audit_note text null, origin_record_id uuid null, service_year integer null, case_number text null, improvement_records jsonb null default '[]'::jsonb,
  constraint service_record_staging_pkey primary key (id), constraint service_record_staging_case_number_key unique (case_number),
  constraint service_record_staging_origin_record_id_fkey foreign KEY (origin_record_id) references service_records (id),
  constraint service_record_staging_workplace_id_fkey foreign KEY (workplace_id) references workplaces (id)
) TABLESPACE pg_default;

create table public.evidence (
  id uuid not null default gen_random_uuid (),
  created_at timestamp with time zone null default now(), updated_at timestamp with time zone null default now(), updated_by text null,
  workplace_id uuid null, consultant_id uuid null, visit_date date null, service_year integer null, start_time time without time zone null, end_time time without time zone null,
  execution_items text null, file_url text null, status text null default 'pending'::text, attachment_folder_id uuid null, is_special_case boolean null default false,
  audit_note text null, additional_appendices jsonb not null default '[]'::jsonb, review_date date null, assessment_records jsonb null default '[]'::jsonb, assessment_updated_by text null,
  evaluation_reviews jsonb null default '[]'::jsonb, improvement_records jsonb null default '[]'::jsonb, evaluation_status text null default 'pending'::text, case_number text null,
  reviewer_id uuid null, service_type text null, process_desc text null, issues_found text null, measures_taken text null, work_pattern text null, hazard_desc text null, tracking_status text null,
  origin_staging_id uuid null, assessment_logs jsonb null default '[]'::jsonb, act_improvements jsonb null default '[]'::jsonb,
  constraint evidence_pkey primary key (id), constraint evidence_case_number_key unique (case_number),
  constraint evidence_consultant_id_fkey foreign KEY (consultant_id) references medical_staff (id),
  constraint evidence_origin_staging_id_fkey foreign KEY (origin_staging_id) references service_record_staging (id),
  constraint evidence_workplace_id_fkey foreign KEY (workplace_id) references workplaces (id) on delete CASCADE
) TABLESPACE pg_default;

-- 9. 建立 RLS Policies (精簡版)
ALTER TABLE public.audit_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.companies ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.evidence ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.medical_staff ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.service_record_staging ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.service_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.workplaces ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Enable insert for all" ON public.audit_logs FOR INSERT TO public WITH CHECK (true);
CREATE POLICY "Enable select for all" ON public.audit_logs FOR SELECT TO public USING (true);
CREATE POLICY "Allow All" ON public.companies FOR ALL TO public USING (true) WITH CHECK (true);
CREATE POLICY "Enable all access for evidence" ON public.evidence FOR ALL TO public USING (true) WITH CHECK (true);
CREATE POLICY "Allow All" ON public.medical_staff FOR ALL TO public USING (true) WITH CHECK (true);
CREATE POLICY "Admins can insert profiles" ON public.profiles FOR INSERT TO authenticated WITH CHECK ( (SELECT profiles.role FROM profiles WHERE profiles.id = auth.uid()) = 'admin' );
CREATE POLICY "Enable read access for all authenticated users" ON public.profiles FOR SELECT TO authenticated USING ( true );
CREATE POLICY "Enable update for own profile" ON public.profiles FOR UPDATE TO authenticated USING ( auth.uid() = id ) WITH CHECK ( auth.uid() = id );
CREATE POLICY "Allow authenticated insert" ON public.service_record_staging FOR INSERT TO authenticated WITH CHECK (true);
CREATE POLICY "Allow authenticated select" ON public.service_record_staging FOR SELECT TO authenticated USING (true);
CREATE POLICY "Allow authenticated update" ON public.service_record_staging FOR UPDATE TO authenticated USING (true);
CREATE POLICY "Allow All" ON public.service_records FOR ALL TO public USING (true) WITH CHECK (true);
CREATE POLICY "Allow All" ON public.workplaces FOR ALL TO public USING (true) WITH CHECK (true);

-- ==============================================================================
-- 第二部分：建立 Storage Buckets 與 Policies
-- ==============================================================================
INSERT INTO storage.buckets (id, name, public)
VALUES 
  ('plans', 'plans', true),
  ('evidence', 'evidence', true),
  ('staging', 'staging', true) -- ⚠️ Staging 設定為 Public
ON CONFLICT (id) DO UPDATE SET public = EXCLUDED.public;

CREATE POLICY "Allow public select plans" ON storage.objects FOR SELECT TO public USING (bucket_id = 'plans');
CREATE POLICY "Allow authenticated insert plans" ON storage.objects FOR INSERT TO authenticated WITH CHECK (bucket_id = 'plans');
CREATE POLICY "Allow authenticated update plans" ON storage.objects FOR UPDATE TO authenticated USING (bucket_id = 'plans');
CREATE POLICY "Allow authenticated delete plans" ON storage.objects FOR DELETE TO authenticated USING (bucket_id = 'plans');

CREATE POLICY "Allow Public Select evidence" ON storage.objects FOR SELECT TO public USING (bucket_id = 'evidence');
CREATE POLICY "Allow Public Insert evidence" ON storage.objects FOR INSERT TO public WITH CHECK (bucket_id = 'evidence');
CREATE POLICY "Allow Public Update evidence" ON storage.objects FOR UPDATE TO public USING (bucket_id = 'evidence');

CREATE POLICY "Allow authenticated select staging" ON storage.objects FOR SELECT TO authenticated USING (bucket_id = 'staging');
CREATE POLICY "Allow authenticated insert staging" ON storage.objects FOR INSERT TO authenticated WITH CHECK (bucket_id = 'staging');
CREATE POLICY "Allow authenticated update staging" ON storage.objects FOR UPDATE TO authenticated USING (bucket_id = 'staging');
CREATE POLICY "Allow authenticated delete staging" ON storage.objects FOR DELETE TO authenticated USING (bucket_id = 'staging');
`;

        function generateSQL() {
            const projectUrlInput = document.getElementById('db-project-url').value.trim();
            const serviceKey = document.getElementById('db-service-key').value.trim();
            const statusDiv = document.getElementById('status-db');

            if (!projectUrlInput || !serviceKey) {
                statusDiv.innerText = "❌ 請完整填寫網址與 Key";
                statusDiv.className = "status-msg status-error";
                return;
            }

            let cleanUrl = projectUrlInput.replace(/\/functions\/v1\/verify-storage\/?$/, '');
            if (cleanUrl.endsWith('/')) cleanUrl = cleanUrl.slice(0, -1);
            const fullUrl = `${cleanUrl}/functions/v1/verify-storage`;

            let finalSQL = SQL_TEMPLATE.replace('<<URL_PLACEHOLDER>>', fullUrl)
                                       .replace('<<TOKEN_PLACEHOLDER>>', serviceKey);

            const blob = new Blob([finalSQL], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "DB_Reconstruction.sql";
            link.click();

            statusDiv.innerText = "✅ SQL 檔已下載，請至 Supabase SQL Editor 執行";
            statusDiv.className = "status-msg status-success";
        }

        // ==========================================
        // 2. Edge Functions 打包邏輯
        // ==========================================
        async function generateEdgeZip() {
            const sender = document.getElementById('ef-sender').value.trim();
            const login = document.getElementById('ef-login').value.trim();
            const reset = document.getElementById('ef-reset').value.trim();
            const act = document.getElementById('ef-act').value.trim();
            const statusDiv = document.getElementById('status-ef');

            if (!sender || !login || !reset || !act) {
                statusDiv.innerText = "❌ 請完整填寫所有欄位";
                statusDiv.className = "status-msg status-error";
                return;
            }

            statusDiv.innerText = "⏳ 正在打包 ZIP...";
            statusDiv.className = "status-msg";

            const zip = new JSZip();

            const files = {
                "reset-password": `import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const RESEND_API_KEY = Deno.env.get("RESEND_API_KEY");
const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");

const corsHeaders = { "Access-Control-Allow-Origin": "*", "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type" };

serve(async (req) => {
  if (req.method === "OPTIONS") return new Response("ok", { headers: corsHeaders });
  try {
    const { email } = await req.json();
    const finalRedirectUrl = "${reset}";
    const supabaseAdmin = createClient(SUPABASE_URL!, SUPABASE_SERVICE_ROLE_KEY!);
    const { data: linkData, error } = await supabaseAdmin.auth.admin.generateLink({ type: "recovery", email, options: { redirectTo: finalRedirectUrl } });
    if (error) throw error;
    
    await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: \`Bearer \${RESEND_API_KEY}\` },
      body: JSON.stringify({
        from: "OHACSS System <${sender}>", to: email, subject: "重設密碼通知",
        html: \`<a href="\${linkData.properties.action_link}">點此重設密碼</a>\`
      })
    });
    return new Response(JSON.stringify({success:true}), { headers: { ...corsHeaders, "Content-Type": "application/json" } });
  } catch (e) { return new Response(JSON.stringify({error:e.message}), { status: 400, headers: corsHeaders }); }
});`,

                "send-email": `import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
const RESEND_API_KEY = Deno.env.get("RESEND_API_KEY");
const corsHeaders = { "Access-Control-Allow-Origin": "*", "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type" };

serve(async (req) => {
  if (req.method === "OPTIONS") return new Response("ok", { headers: corsHeaders });
  try {
    const { type, email, data } = await req.json();
    const LOGIN_URL = "${login}";
    
    await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: \`Bearer \${RESEND_API_KEY}\` },
      body: JSON.stringify({
        from: "OHACSS Admin <${sender}>", to: email, subject: "帳號開通通知",
        html: \`帳號: \${data.email}<br>密碼: 12345678<br><a href="\${LOGIN_URL}">登入系統</a>\`
      })
    });
    return new Response(JSON.stringify({success:true}), { headers: { ...corsHeaders, "Content-Type": "application/json" } });
  } catch (e) { return new Response(JSON.stringify({error:e.message}), { status: 400, headers: corsHeaders }); }
});`,

                "send-evaluation-revision": `import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
const RESEND_API_KEY = Deno.env.get("RESEND_API_KEY");
const SUPABASE_URL = Deno.env.get("SUPABASE_URL");
const SERVICE_ROLE_KEY = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY");
const corsHeaders = { "Access-Control-Allow-Origin": "*", "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type" };

serve(async (req) => {
  if (req.method === "OPTIONS") return new Response("ok", { headers: corsHeaders });
  try {
    const { id } = await req.json();
    const dbRes = await fetch(\`\${SUPABASE_URL}/rest/v1/evidence?id=eq.\${id}&select=case_number,medical_staff(email)\`, { headers: { apikey: SERVICE_ROLE_KEY!, Authorization: \`Bearer \${SERVICE_ROLE_KEY}\` } });
    const [data] = await dbRes.json();
    
    await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: \`Bearer \${RESEND_API_KEY}\` },
      body: JSON.stringify({
        from: "OHACSS <${sender}>", to: data.medical_staff.email, subject: "評鑑補件通知",
        html: \`案號: \${data.case_number}<br><a href="${act}">前往評鑑改善專區</a>\`
      })
    });
    return new Response(JSON.stringify({success:true}), { headers: { ...corsHeaders, "Content-Type": "application/json" } });
  } catch (e) { return new Response(JSON.stringify({error:e.message}), { status: 400, headers: corsHeaders }); }
});`,

                "send-reminder": `import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
const RESEND_API_KEY = Deno.env.get("RESEND_API_KEY");
const corsHeaders = { "Access-Control-Allow-Origin": "*", "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type" };

serve(async (req) => {
  if (req.method === "OPTIONS") return new Response("ok", { headers: corsHeaders });
  try {
    const { email, companyName } = await req.json();
    await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: \`Bearer \${RESEND_API_KEY}\` },
      body: JSON.stringify({
        from: "OHSMS <${sender}>", to: email, subject: "催收通知",
        html: \`請盡速處理 \${companyName} 案件<br><a href="${login}">登入</a>\`
      })
    });
    return new Response(JSON.stringify({success:true}), { headers: { ...corsHeaders, "Content-Type": "application/json" } });
  } catch (e) { return new Response(JSON.stringify({error:e.message}), { status: 400, headers: corsHeaders }); }
});`,

                "send-review": `import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
const RESEND_API_KEY = Deno.env.get("RESEND_API_KEY");
const corsHeaders = { "Access-Control-Allow-Origin": "*", "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type" };

serve(async (req) => {
  if (req.method === "OPTIONS") return new Response("ok", { headers: corsHeaders });
  try {
    const { email, caseNo, reason } = await req.json();
    await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: { "Content-Type": "application/json", Authorization: \`Bearer \${RESEND_API_KEY}\` },
      body: JSON.stringify({
        from: "OHACSS <${sender}>", to: email, subject: \`案件補正通知 \${caseNo}\`,
        html: \`原因: \${reason}<br><a href="${login}">登入處理</a>\`
      })
    });
    return new Response(JSON.stringify({success:true}), { headers: { ...corsHeaders, "Content-Type": "application/json" } });
  } catch (e) { return new Response(JSON.stringify({error:e.message}), { status: 400, headers: corsHeaders }); }
});`,

                "verify-storage": `import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
const corsHeaders = { 'Access-Control-Allow-Origin': '*', 'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type' }

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') return new Response('ok', { headers: corsHeaders })
  try {
    const supabase = createClient(Deno.env.get('SUPABASE_URL')!, Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!)
    const { record_id } = await req.json()
    const { data: record } = await supabase.from('service_records').select('attachment_files').eq('id', record_id).single()
    const isVerified = true; 
    await supabase.from('service_records').update({ storage_verified: isVerified, last_verification_at: new Date().toISOString() }).eq('id', record_id)
    return new Response(JSON.stringify({ verified: isVerified }), { headers: { ...corsHeaders, 'Content-Type': 'application/json' } })
  } catch (err) { return new Response(JSON.stringify({ error: err.message }), { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }) }
})`
            };

            for (const [name, content] of Object.entries(files)) {
                zip.file(`supabase/functions/${name}/index.ts`, content);
            }

            const blob = await zip.generateAsync({type:"blob"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "supabase_functions.zip";
            link.click();

            statusDiv.innerText = "✅ ZIP 檔已下載，請解壓並執行 CLI 部署";
            statusDiv.className = "status-msg status-success";
        }

        // ==========================================
        // 3. Config.js 產生邏輯 (新功能)
        // ==========================================
        function generateConfig() {
            const url = document.getElementById('cfg-url').value.trim();
            const anonKey = document.getElementById('cfg-anon-key').value.trim();
            const statusDiv = document.getElementById('status-cfg');

            if (!url || !anonKey) {
                statusDiv.innerText = "❌ 請完整填寫網址與 Anon Key";
                statusDiv.className = "status-msg status-error";
                return;
            }

            // 清理網址斜線
            const cleanUrl = url.endsWith('/') ? url.slice(0, -1) : url;

            const configContent = `// config.js
// 目的：集中管理 全站共用設定 (資料庫、品牌資訊、頁面路徑)

const AppConfig = {
    // 1. 資料庫連線設定 (Supabase)
    Supabase: {
        URL: '${cleanUrl}',
        KEY: '${anonKey}', 
        BUCKET_NAME: 'staging'
    },

    // 2. 系統品牌資訊
    System: {
        APP_NAME: 'OHACSS 職業健康評鑑與合規支援系統',
        COMPANY_NAME: '可信智慧整合有限公司',
        TAX_ID: '42917004',
        SLOGAN: 'WesmartAI , Making Trust Transparent.'
    },

    // 3. 核心頁面路徑對照 (相對路徑即可)
    Paths: {
        LOGIN: 'index.html',
        DASHBOARD: 'dashboard.html',
        RESET_PASSWORD: 'reset_password.html',
        INDEX: 'index.html'
    },

    // 4. Storage Keys
    StorageKeys: {
        USER_ID: 'currentUserId',
        USER_ROLE: 'currentUserRole',
        USER_NAME: 'currentUserName'
    }
};

window.AppConfig = AppConfig;
`;

            const blob = new Blob([configContent], { type: 'text/javascript' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "config.js";
            link.click();

            statusDiv.innerText = "✅ config.js 檔已下載，請覆蓋前端對應檔案";
            statusDiv.className = "status-msg status-success";
        }
    </script>
</body>
</html>
